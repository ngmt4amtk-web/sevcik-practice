<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>セビシック練習</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#1a1a2e;color:#eee;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;padding:16px 12px;
  -webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
h1{font-size:1.5rem;margin-bottom:8px}
h2{font-size:1.15rem;margin-bottom:12px;color:#bbb;font-weight:normal}
.screen{display:none;width:100%;max-width:420px;text-align:center;flex-direction:column;align-items:center}
.screen.active{display:flex}
.btn{display:inline-flex;align-items:center;justify-content:center;
  min-width:56px;min-height:48px;padding:10px 18px;border:none;border-radius:12px;
  font-size:1.15rem;font-weight:600;cursor:pointer;touch-action:manipulation;
  transition:transform .1s,opacity .1s;-webkit-appearance:none}
.btn:active{transform:scale(.95)}
.btn:disabled{opacity:.25;pointer-events:none}
.btn-primary{background:#e94560;color:#fff}
.btn-secondary{background:#0f3460;color:#fff}
.btn-accent{background:#4ecca3;color:#1a1a2e}
.btn-string{width:76px;height:76px;font-size:2rem;border-radius:50%;
  background:#16213e;border:3px solid #334;color:#eee}
.btn-string:active{background:#e94560;border-color:#e94560}
.string-grid{display:flex;gap:14px;margin:24px 0}
.acc-grid{display:flex;gap:12px;margin:14px 0}
.acc-grid .btn{width:68px;height:58px;font-size:1.6rem}
.staff-box{width:100%;max-width:340px;background:#16213e;border-radius:12px;padding:8px;margin:8px 0}
.note-big{font-size:2.8rem;font-weight:700;margin:6px 0;color:#4ecca3}
.finger-lbl{font-size:1.05rem;color:#aaa;margin:4px 0}
.chips{display:flex;gap:5px;margin:8px 0;flex-wrap:wrap;justify-content:center}
.chip{background:#0f3460;padding:4px 10px;border-radius:8px;font-size:.85rem}
.chip.cur{background:#e94560}
.interval-list{width:100%;max-width:340px;margin:12px 0}
.iv-row{display:flex;align-items:center;padding:4px 0}
.iv-finger{background:#0f3460;padding:7px 12px;border-radius:8px;font-size:.95rem;min-width:90px;text-align:center}
.iv-line{flex:1;display:flex;align-items:center;justify-content:center;padding:0 6px}
.iv-line span{font-size:.8rem;color:#4ecca3;white-space:nowrap}
.iv-line.close span{color:#e94560}
.iv-connector{width:2px;height:18px;background:#334;margin:0 auto}
.meter-wrap{width:100%;max-width:320px;margin:10px 0}
.meter-bg{height:36px;background:#16213e;border-radius:8px;position:relative;overflow:hidden}
.meter-zone{position:absolute;left:35%;top:0;height:100%;width:30%;background:rgba(78,204,163,.15)}
.meter-mid{position:absolute;left:50%;top:0;height:100%;width:1px;background:rgba(255,255,255,.2)}
.meter-needle{position:absolute;top:2px;bottom:2px;width:3px;background:#e94560;
  left:50%;transform:translateX(-50%);border-radius:2px;transition:left .06s}
.meter-labels{display:flex;justify-content:space-between;font-size:.7rem;color:#666;margin-top:2px;padding:0 2px}
.cents-val{font-size:1.4rem;font-weight:700;margin:4px 0}
.cents-val.ok{color:#4ecca3}
.cents-val.ng{color:#e94560}
.hold-wrap{width:100%;max-width:320px;margin:6px 0}
.hold-lbl{font-size:.8rem;color:#777;margin-bottom:3px}
.hold-bg{height:6px;background:#16213e;border-radius:3px;overflow:hidden}
.hold-fill{height:100%;width:0;background:#4ecca3;border-radius:3px;transition:width .08s linear}
.prog-wrap{width:100%;max-width:320px;margin:8px 0}
.prog-bg{height:7px;background:#16213e;border-radius:4px;overflow:hidden}
.prog-fill{height:100%;background:#4ecca3;transition:width .3s;border-radius:4px}
.prog-txt{font-size:.8rem;color:#777;margin-top:3px}
.back-btn{position:fixed;top:12px;left:12px;background:none;border:none;color:#888;
  font-size:1.6rem;cursor:pointer;z-index:10;touch-action:manipulation;padding:8px}
.done-title{font-size:2.2rem;color:#4ecca3;margin-bottom:16px}
.pass-flash{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.5);
  font-size:12rem;font-weight:900;color:#4ecca3;pointer-events:none;opacity:0;z-index:50;
  text-shadow:0 0 40px rgba(78,204,163,.4);line-height:1}
.pass-flash.show{animation:passPop .55s ease-out forwards}
@keyframes passPop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.3)}
  25%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}
  50%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  100%{opacity:0;transform:translate(-50%,-50%) scale(1.15)}
}
.pass-finger{font-size:2.2rem;font-weight:700;margin-top:-.5rem}
</style>
</head>
<body>

<button class="back-btn" id="backBtn" onclick="goBack()" style="display:none">&larr;</button>
<div class="pass-flash" id="passFlash">○</div>

<!-- Step 1 -->
<div class="screen active" id="step1">
<h1>セビシック練習</h1>
<h2>弦を選択してください</h2>
<div class="string-grid">
<button class="btn btn-string" onclick="pickString('G')" style="border-color:#4a9eff;color:#4a9eff">G</button>
<button class="btn btn-string" onclick="pickString('D')" style="border-color:#ff8c00;color:#ff8c00">D</button>
<button class="btn btn-string" onclick="pickString('A')" style="border-color:#e94560;color:#e94560">A</button>
<button class="btn btn-string" onclick="pickString('E')" style="border-color:#4ecca3;color:#4ecca3">E</button>
</div>
</div>

<!-- Step 2 -->
<div class="screen" id="step2">
<h2 id="s2title">指0の音を選んでください</h2>
<div class="chips" id="s2chips"></div>
<div class="staff-box"><svg id="svg2" viewBox="0 0 260 160" width="100%"></svg></div>
<div class="note-big" id="s2note"></div>
<div class="acc-grid">
<button class="btn btn-secondary" id="btnF" onclick="pickAcc(-1)">&#9837;</button>
<button class="btn btn-secondary" id="btnN" onclick="pickAcc(0)">&#9838;</button>
<button class="btn btn-secondary" id="btnS" onclick="pickAcc(1)">&#9839;</button>
</div>
</div>

<!-- Step 3 -->
<div class="screen" id="step3">
<h2 id="s3title"></h2>
<div class="staff-box"><svg id="svg3" viewBox="0 0 260 160" width="100%"></svg></div>
<div class="interval-list" id="s3intervals"></div>
<div style="display:flex;gap:10px;margin-top:12px">
<button class="btn btn-accent" onclick="timeAttack=false;startPractice()" style="font-size:1.2rem;padding:14px 28px">練習スタート</button>
<button class="btn btn-primary" onclick="timeAttack=true;startPractice()" style="font-size:1.2rem;padding:14px 28px">⏱ タイムアタック</button>
</div>
<button class="btn" onclick="openSettings()" style="margin-top:10px;font-size:.9rem;padding:8px 18px;background:#16213e;color:#888">⚙ 設定</button>
</div>

<!-- Step 4 -->
<div class="screen" id="step4">
<div id="timerDisp" style="font-size:1.6rem;font-weight:700;color:#e94560;margin-bottom:4px;display:none">00:00.0</div>
<div class="finger-lbl" id="s4finger"></div>
<div class="note-big" id="s4note"></div>
<div class="staff-box"><svg id="svg4" viewBox="0 0 260 160" width="100%"></svg></div>
<button class="btn btn-secondary" id="playBtn" onclick="playRef()" style="margin:6px 0;font-size:1rem;padding:10px 20px">&#128266; 基準音を聴く</button>
<div class="cents-val" id="centsDisp">-- cent</div>
<div class="meter-wrap">
<div class="meter-bg">
<div class="meter-zone"></div>
<div class="meter-mid"></div>
<div class="meter-needle" id="needle"></div>
</div>
<div class="meter-labels"><span>-50</span><span>-25</span><span>0</span><span>+25</span><span>+50</span></div>
</div>
<div class="hold-wrap">
<div class="hold-lbl" id="holdLbl">音を保持してください</div>
<div class="hold-bg"><div class="hold-fill" id="holdFill"></div></div>
</div>
<div class="prog-wrap">
<div class="prog-bg"><div class="prog-fill" id="progFill"></div></div>
<div class="prog-txt" id="progTxt">1 / 24</div>
</div>
<button class="btn btn-secondary" id="skipBtn" onclick="skipNext()" style="margin-top:10px;font-size:1rem;padding:10px 28px;display:none">次へ &rarr;</button>
</div>

<!-- Step 5 -->
<div class="screen" id="step5">
<div style="margin-top:60px">
<div class="done-title">お疲れ様！</div>
<p id="doneMsg" style="color:#aaa;margin-bottom:12px">全24音をクリアしました</p>
<p id="doneTime" style="color:#e94560;font-size:1.4rem;font-weight:700;margin-bottom:28px;display:none"></p>
<div style="display:flex;gap:12px">
<button class="btn btn-accent" onclick="retryPractice()" style="font-size:1.1rem;padding:14px 24px">もう一度</button>
<button class="btn btn-secondary" onclick="resetApp()" style="font-size:1.1rem;padding:14px 24px">最初から</button>
</div>
</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center" onclick="if(event.target===this)closeSettings()">
<div style="background:#16213e;border-radius:16px;padding:24px;width:90%;max-width:340px;text-align:left">
<h3 style="font-size:1.1rem;margin-bottom:16px;text-align:center">⚙ 設定</h3>
<div style="margin-bottom:14px">
<label style="font-size:.9rem;color:#aaa">A =</label>
<select id="baseASelect" onchange="baseA=+this.value" style="margin-left:8px;background:#1a1a2e;color:#eee;border:1px solid #334;border-radius:6px;padding:6px 10px;font-size:.95rem">
<option value="440">440 Hz</option>
<option value="441">441 Hz</option>
<option value="442" selected>442 Hz</option>
<option value="443">443 Hz</option>
<option value="444">444 Hz</option>
</select>
</div>
<div style="margin-bottom:14px">
<label style="font-size:.9rem;color:#aaa">モード</label>
<select id="modeSelect" onchange="mode=this.value" style="margin-left:8px;background:#1a1a2e;color:#eee;border:1px solid #334;border-radius:6px;padding:6px 10px;font-size:.95rem">
<option value="full" selected>登り降り（24音）</option>
<option value="asc">登りのみ（12音）</option>
</select>
</div>
<div style="margin-bottom:18px">
<label style="font-size:.9rem;color:#aaa">音程幅</label>
<select id="tolSelect" onchange="tolerance=+this.value;updMeterZone()" style="margin-left:8px;background:#1a1a2e;color:#eee;border:1px solid #334;border-radius:6px;padding:6px 10px;font-size:.95rem">
<option value="25">やさしい（±25c）</option>
<option value="15" selected>ふつう（±15c）</option>
<option value="8">きびしい（±8c）</option>
</select>
</div>
<div style="text-align:center">
<button class="btn btn-secondary" onclick="closeSettings()" style="padding:10px 32px;font-size:1rem">閉じる</button>
</div>
</div>
</div>

<script>
/* ===== Data ===== */
const SD = {
  G:{n:['G','A','B','C','D'],o:[3,3,3,4,4],jp:['ソ','ラ','シ','ド','レ']},
  D:{n:['D','E','F','G','A'],o:[4,4,4,4,4],jp:['レ','ミ','ファ','ソ','ラ']},
  A:{n:['A','B','C','D','E'],o:[4,4,5,5,5],jp:['ラ','シ','ド','レ','ミ']},
  E:{n:['E','F','G','A','B'],o:[5,5,5,5,5],jp:['ミ','ファ','ソ','ラ','シ']}
};
const NP={C:0,D:1,E:2,F:3,G:4,A:5,B:6};
/* ===== Pythagorean Tuning ===== */
let baseA=442;
const APOTOME=2187/2048;
const PYTH={
  G:[1,9/8,81/64,4/3,3/2],
  D:[1,9/8,32/27,4/3,3/2],
  A:[1,9/8,32/27,4/3,3/2],
  E:[1,256/243,32/27,4/3,3/2]
};
function openHz(s){const d=baseA*2/3,g=d*2/3,e=baseA*3/2;return{G:g,D:d,A:baseA,E:e}[s]}
function noteHz(s,f){return openHz(s)*PYTH[s][f]}
const SEQ=[0,1,0,1,2,1,2,3,2,3,4,3,2,3,2,3,4,3,2,3,2,1,2,1];

/* ===== State ===== */
let str=null,cFinger=0,fc=[],pIdx=0;
let actx=null,analyser=null,mic=null,raf=null,holdT=null,passed=false,step=1;
let mode='full',tolerance=15,timeAttack=false,startTime=null;
const STR_COL={G:'#4a9eff',D:'#ff8c00',A:'#e94560',E:'#4ecca3'};

/* ===== Helpers ===== */
function sPos(note,oct){return(oct-4)*7+NP[note]}
function p2y(p){return 122-p*7}
function hzAcc(base,a){return a===-1?base/APOTOME:a===1?base*APOTOME:base}
function jpAcc(base,a){return base+(a===-1?'♭':a===1?'♯':'')}
function accSym(a){return a===-1?'♭':a===1?'♯':''}
function getSeq(){return mode==='asc'?SEQ.slice(0,12):SEQ}
function updMeterZone(){
  const z=document.querySelector('.meter-zone');if(!z)return;
  if(tolerance===25){z.style.left='25%';z.style.width='50%'}
  else if(tolerance===8){z.style.left='42%';z.style.width='16%'}
  else{z.style.left='35%';z.style.width='30%'}
}

/* ===== Ledger Lines ===== */
function ledgers(pos){
  const L=[];
  if(pos<=0){for(let p=0;p>=pos;p-=2)L.push(p)}
  if(pos>=12){for(let p=12;p<=pos;p+=2)L.push(p)}
  return L;
}

/* ===== SVG Staff ===== */
function drawStaff(id,notes,hiIdx){
  const svg=document.getElementById(id);
  let h='';
  // staff lines
  for(const p of[2,4,6,8,10]){
    const y=p2y(p);
    h+=`<line x1="15" y1="${y}" x2="245" y2="${y}" stroke="#556" stroke-width="1.5"/>`;
  }
  // treble clef
  h+=`<text x="14" y="${p2y(4)+28}" font-size="72" fill="#778" font-family="serif">&#119070;</text>`;

  if(!Array.isArray(notes))notes=[notes];
  const multi=notes.length>1;

  notes.forEach((nt,i)=>{
    if(!nt)return;
    const{sp,acc}=nt;
    const y=p2y(sp);
    const hi=hiIdx!==undefined?i===hiIdx:true;
    const col=hi?'#fff':'#667';
    const nx=multi?65+i*38:150;

    // ledger lines
    for(const lp of ledgers(sp)){
      const ly=p2y(lp);
      h+=`<line x1="${nx-14}" y1="${ly}" x2="${nx+14}" y2="${ly}" stroke="#556" stroke-width="1.5"/>`;
    }
    // note head
    h+=`<ellipse cx="${nx}" cy="${y}" rx="8" ry="5.5" fill="${col}" transform="rotate(-12,${nx},${y})"/>`;
    // stem
    if(sp<6){
      h+=`<line x1="${nx+7}" y1="${y}" x2="${nx+7}" y2="${y-35}" stroke="${col}" stroke-width="1.5"/>`;
    }else{
      h+=`<line x1="${nx-7}" y1="${y}" x2="${nx-7}" y2="${y+35}" stroke="${col}" stroke-width="1.5"/>`;
    }
    // accidental
    if(acc!==0){
      const sym=acc===-1?'♭':'♯';
      h+=`<text x="${nx-22}" y="${y+6}" font-size="17" fill="${col}" font-family="serif">${sym}</text>`;
    }
  });
  svg.innerHTML=h;
}

/* ===== Navigation ===== */
function show(s){
  document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));
  document.getElementById('step'+s).classList.add('active');
  document.getElementById('backBtn').style.display=(s>1&&s<5)?'block':'none';
  step=s;
}
function goBack(){
  if(step===4){stopDetect();show(3)}
  else if(step===3){cFinger=4;fc.pop();show(2);updS2()}
  else if(step===2){
    if(cFinger>0){cFinger--;fc.pop();updS2()}
    else show(1);
  }
}

/* ===== Step 1 ===== */
function pickString(s){str=s;cFinger=0;fc=[];show(2);updS2()}

/* ===== Step 2 ===== */
function updS2(){
  const d=SD[str],f=cFinger;
  document.getElementById('s2title').textContent=`指${f}の音を選んでください`;
  document.getElementById('s2note').textContent=d.jp[f];
  document.getElementById('btnF').disabled=f===0;
  document.getElementById('btnS').disabled=f===0;

  const sp=sPos(d.n[f],d.o[f]);
  drawStaff('svg2',[{sp,acc:0}]);

  let chips='';
  for(let i=0;i<5;i++){
    if(i<fc.length) chips+=`<span class="chip">${fc[i].jp}</span>`;
    else if(i===cFinger) chips+=`<span class="chip cur">指${i}</span>`;
    else chips+=`<span class="chip" style="opacity:.3">指${i}</span>`;
  }
  document.getElementById('s2chips').innerHTML=chips;
}
function pickAcc(a){
  const d=SD[str],f=cFinger;
  const sp=sPos(d.n[f],d.o[f]);
  const hz=hzAcc(noteHz(str,f),a);
  const jp=jpAcc(d.jp[f],a);
  fc.push({acc:a,hz,jp,sp});
  cFinger++;
  if(cFinger>=5){show(3);updS3()}
  else updS2();
}

/* ===== Step 3 ===== */
function updS3(){
  const names=fc.map(f=>f.jp).join('・');
  const col=STR_COL[str]||'#4ecca3';
  const s3t=document.getElementById('s3title');
  s3t.textContent=`${str}線　${names}`;
  s3t.style.color=col;

  drawStaff('svg3',fc.map(f=>({sp:f.sp,acc:f.acc})));

  const isClose=(a,b)=>Math.abs(Math.round(1200*Math.log2(b/a)))<150;
  function advice(i){
    if(i===0)return '';
    if(i===1)return isClose(fc[0].hz,fc[1].hz)?'低め':'高め';
    if(i===2){
      if(isClose(fc[1].hz,fc[2].hz))return '1とくっつける';
      if(isClose(fc[2].hz,fc[3].hz))return '3とくっつける';
      const c=Math.round(1200*Math.log2(fc[2].hz/openHz(str)));
      return c<350?'低め':'高め';
    }
    if(i===3){
      if(isClose(fc[2].hz,fc[3].hz))return '2とくっつける';
      if(isClose(fc[3].hz,fc[4].hz))return '4とくっつける';
      return '気持ち高め';
    }
    if(i===4)return isClose(fc[3].hz,fc[4].hz)?'3とくっつける':'高め';
    return '';
  }
  let html='';
  for(let i=0;i<5;i++){
    const adv=advice(i);
    const advHtml=adv?`<span style="color:#4ecca3;font-size:.85rem;margin-left:8px">${adv}</span>`:'';
    html+=`<div class="iv-row"><div class="iv-finger">指${i}　${fc[i].jp}${advHtml}</div></div>`;
  }
  document.getElementById('s3intervals').innerHTML=html;
}

/* ===== Step 4 ===== */
async function startPractice(){
  pIdx=0;holdT=null;
  if(timeAttack)startTime=Date.now();else startTime=null;
  updMeterZone();
  show(4);updS4();
  if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)();
  if(actx.state==='suspended')await actx.resume();
  await startDetect();
}
function updS4(){
  const seq=getSeq();
  const fi=seq[pIdx],nt=fc[fi];
  const col=STR_COL[str]||'#4ecca3';
  document.getElementById('s4finger').textContent=`指${fi}`;
  const noteEl=document.getElementById('s4note');
  noteEl.textContent=nt.jp;
  noteEl.style.color=col;
  drawStaff('svg4',[{sp:nt.sp,acc:nt.acc}]);
  document.getElementById('progFill').style.width=`${(pIdx/seq.length)*100}%`;
  document.getElementById('progTxt').textContent=`${pIdx+1} / ${seq.length}`;
  document.getElementById('centsDisp').textContent='-- cent';
  document.getElementById('centsDisp').className='cents-val';
  document.getElementById('needle').style.left='50%';
  document.getElementById('holdFill').style.width='0';
  const holdWrap=document.querySelector('.hold-wrap');
  if(timeAttack){
    holdWrap.style.display='none';
  }else{
    holdWrap.style.display='';
    document.getElementById('holdLbl').textContent='音を保持してください';
  }
  document.getElementById('timerDisp').style.display=timeAttack?'block':'none';
  document.getElementById('skipBtn').style.display=timeAttack?'none':'inline-flex';
  holdT=null;passed=false;
}
function playRef(){
  const fi=getSeq()[pIdx],hz=fc[fi].hz;
  if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)();
  if(actx.state==='suspended')actx.resume();
  const osc=actx.createOscillator(),g=actx.createGain();
  osc.type='sine';osc.frequency.value=hz;
  g.gain.setValueAtTime(.3,actx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+1);
  osc.connect(g);g.connect(actx.destination);
  osc.start();osc.stop(actx.currentTime+1);
}

/* ===== Pitch Detection ===== */
async function startDetect(){
  try{
    mic=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
    const src=actx.createMediaStreamSource(mic);
    analyser=actx.createAnalyser();
    analyser.fftSize=4096;
    src.connect(analyser);
    detect();
  }catch(e){alert('マイクへのアクセスが必要です。設定を確認してください。')}
}
function stopDetect(){
  if(raf){cancelAnimationFrame(raf);raf=null}
  if(mic){mic.getTracks().forEach(t=>t.stop());mic=null}
}
function detect(){
  if(!analyser||step!==4)return;
  const buf=new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);
  const hz=acorr(buf,actx.sampleRate);
  const seq=getSeq();
  const tgt=fc[seq[pIdx]].hz;

  // タイマー更新
  if(timeAttack&&startTime){
    const el=Date.now()-startTime;
    const m=Math.floor(el/60000);const s=((el%60000)/1000).toFixed(1);
    document.getElementById('timerDisp').textContent=`${String(m).padStart(2,'0')}:${s.padStart(4,'0')}`;
  }

  if(hz>100&&hz<1500){
    const cents=Math.round(1200*Math.log2(hz/tgt));
    const cl=Math.max(-50,Math.min(50,cents));
    const ce=document.getElementById('centsDisp');
    ce.textContent=`${cents>0?'+':''}${cents} cent`;
    const ok=Math.abs(cents)<=tolerance;
    ce.className='cents-val '+(ok?'ok':'ng');
    document.getElementById('needle').style.left=`${50+cl}%`;

    if(ok){
      if(!holdT)holdT=Date.now();
      const elapsed=Date.now()-holdT;
      if(timeAttack){
        if(elapsed>=400){advance();return}
      }else{
        const pct=Math.min(100,elapsed/10);
        document.getElementById('holdFill').style.width=pct+'%';
        document.getElementById('holdLbl').textContent='保持中...';
        if(!passed&&elapsed>=500)passed=true;
        if(elapsed>=1000){
          document.getElementById('holdLbl').textContent='合格！';
          document.getElementById('holdLbl').style.color='#4ecca3';
          setTimeout(()=>{document.getElementById('holdLbl').style.color='';advance()},400);
          return;
        }
      }
    }else{
      holdT=null;
      if(!timeAttack){
        if(passed){passed=false;advance();return}
        document.getElementById('holdFill').style.width='0';
        document.getElementById('holdLbl').textContent='音を保持してください';
      }
    }
  }else{
    holdT=null;
    if(!timeAttack){
      document.getElementById('holdFill').style.width='0';
    }
  }
  raf=requestAnimationFrame(detect);
}
function showDone(){
  const seq=getSeq();
  document.getElementById('doneMsg').textContent=`全${seq.length}音をクリアしました`;
  const dt=document.getElementById('doneTime');
  if(timeAttack&&startTime){
    const el=Date.now()-startTime;
    const m=Math.floor(el/60000);const s=((el%60000)/1000).toFixed(1);
    dt.textContent=`⏱ ${String(m).padStart(2,'0')}:${s.padStart(4,'0')}`;
    dt.style.display='block';
  }else{
    dt.style.display='none';
  }
  show(5);
}
function playPassSound(){
  if(!actx)return;
  const now=actx.currentTime;
  [880,1320].forEach((f,i)=>{
    const t=now+i*0.1;
    const g=actx.createGain();
    g.connect(actx.destination);
    g.gain.setValueAtTime(0.1,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
    const o=actx.createOscillator();
    o.type='triangle';o.frequency.value=f;
    o.connect(g);o.start(t);o.stop(t+0.4);
  });
}
function showPass(){
  const el=document.getElementById('passFlash');
  const fi=getSeq()[pIdx];
  const col=STR_COL[str]||'#4ecca3';
  el.style.color=col;
  el.style.textShadow=`0 0 40px ${col}66`;
  el.innerHTML=`○<div class="pass-finger">指${fi}</div>`;
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
  playPassSound();
}
function skipNext(){
  holdT=null;passed=false;
  pIdx++;
  const seq=getSeq();
  if(pIdx>=seq.length){stopDetect();showDone();return}
  updS4();
}
function advance(){
  showPass();
  pIdx++;
  const seq=getSeq();
  if(pIdx>=seq.length){stopDetect();showDone();return}
  updS4();
  raf=requestAnimationFrame(detect);
}

/* ===== Autocorrelation ===== */
function acorr(buf,sr){
  const N=buf.length;
  let rms=0;
  for(let i=0;i<N;i++)rms+=buf[i]*buf[i];
  rms=Math.sqrt(rms/N);
  if(rms<0.008)return -1;

  const corr=new Float32Array(N);
  for(let lag=0;lag<N;lag++){
    let s=0;
    for(let i=0;i<N-lag;i++)s+=buf[i]*buf[i+lag];
    corr[lag]=s;
  }
  // find first dip
  let d=0;
  while(d<N-1&&corr[d]>corr[d+1])d++;
  // find peak after dip
  let mv=-1,mp=d;
  for(let i=d;i<N;i++){if(corr[i]>mv){mv=corr[i];mp=i}}
  if(mp<1||mp>=N-1)return -1;
  // confidence check
  if(mv<0.3*corr[0])return -1;
  // parabolic interpolation
  const y1=corr[mp-1],y2=corr[mp],y3=corr[mp+1];
  const a=(y1+y3-2*y2)/2,b=(y3-y1)/2;
  const shift=a!==0?-b/(2*a):0;
  return sr/(mp+shift);
}

/* ===== Settings Modal ===== */
function openSettings(){document.getElementById('settingsModal').style.display='flex'}
function closeSettings(){document.getElementById('settingsModal').style.display='none'}

/* ===== Reset ===== */
function retryPractice(){stopDetect();pIdx=0;passed=false;startTime=null;startPractice()}
function resetApp(){stopDetect();str=null;cFinger=0;fc=[];pIdx=0;passed=false;startTime=null;show(1)}
</script>
</body>
</html>
